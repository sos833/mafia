<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø§ÙÙŠØ§ - Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø³ØªØ¯ÙŠØ±Ø©</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Lateef&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --primary-red: #8B0000;
            --primary-text: #f0e6d2;
            --background-dark: #000;
            --panel-width-mobile: 300px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body { 
            height: 100%; 
            width: 100%;
            overflow: hidden; /* ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ù„Ù„ØµÙØ­Ø© */
        }
        
        body {
            font-family: 'Lateef', serif;
            background: var(--background-dark);
            color: var(--primary-text);
            display: flex; 
            justify-content: center; 
            align-items: center;
        }

        #bg-video {
            position: fixed; right: 0; bottom: 0;
            min-width: 100%; min-height: 100%;
            z-index: -2; opacity: 0.3; object-fit: cover;
        }
        
        body::before {
            content: ''; position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle, transparent 20%, black 100%);
            z-index: -1;
        }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Setup Screen) --- */
        .setup-container {
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            padding: 20px;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 100;
            position: fixed; top: 0; left: 0;
            transition: opacity 0.5s ease, visibility 0.5s;
        }
        .setup-container.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        
        .setup-box {
            background: rgba(10,10,10,0.8);
            border: 2px solid var(--primary-red);
            border-radius: 15px; padding: 30px;
            max-width: 600px; width: 100%;
            box-shadow: 0 0 30px rgba(139,0,0,0.5);
            max-height: 90vh; /* ÙŠÙ…Ù†Ø¹ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ù…Ù† Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ø·ÙˆÙ„ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© */
            overflow-y: auto; /* ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø£ÙƒØ¨Ø± */
        }
        
        .setup-box h1 {
            font-family: 'Cinzel Decorative', cursive;
            color: var(--primary-red); 
            /* Ø­Ø¬Ù… Ø®Ø· Ù…ØªØ¬Ø§ÙˆØ¨ */
            font-size: clamp(2.2rem, 8vw, 2.8rem); 
            text-align: center;
            margin-bottom: 25px;
        }
        
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block; font-size: 24px; margin-bottom: 8px;
            font-family: 'Cinzel Decorative', cursive;
        }
        
        .form-group input[type="text"], .form-group input[type="number"] {
            width: 100%; background: rgba(0,0,0,0.5);
            border: 1px solid #555; border-radius: 8px;
            padding: 12px; color: var(--primary-text);
            font-family: 'Lateef', serif; font-size: 22px;
        }
        
        .mode-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-btn {
            flex: 1; padding: 10px; font-size: 20px;
            font-family: 'Cinzel Decorative', cursive;
            background: #333; border: 1px solid #555; color: #aaa;
            cursor: pointer; transition: all 0.3s;
        }
        .mode-btn.active { background: var(--primary-red); border-color: #ff0000; color: white; }
        
        #create-options, #join-options { display: none; }
        
        .slider-group { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        input[type="range"] { flex: 1; -webkit-appearance: none; appearance: none; background: #444; height: 8px; border-radius: 4px; outline: none; min-width: 150px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--primary-red); border-radius: 50%; cursor: pointer; border: 2px solid #ff0000;}
        #player-count-display { font-size: 24px; font-weight: bold; color: var(--primary-red); }
        
        .roles-config h3 { font-size: 26px; margin-bottom: 10px; font-family: 'Cinzel Decorative', cursive;}
        .role-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 5px; background: rgba(255,255,255,0.05); border-radius: 5px; }
        .role-name { font-size: 22px; }
        .role-controls { display: flex; align-items: center; gap: 10px; }
        .role-btn {
            width: 30px; height: 30px; border-radius: 50%;
            background: #555; color: white; border: none;
            font-size: 20px; font-weight: bold; cursor: pointer;
        }
        .role-count { font-size: 22px; width: 30px; text-align: center; }
        
        #final-action-btn {
            width: 100%; padding: 15px; font-size: 24px; margin-top: 20px;
            background: linear-gradient(145deg, var(--primary-red), #6B0000);
            border: none; color: white; border-radius: 8px;
            font-family: 'Cinzel Decorative', cursive; cursor: pointer;
        }
        #final-action-btn:disabled { background: #555; cursor: not-allowed; opacity: 0.6; }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© (Game Screen) --- */
        .game-container {
            /* ØªØ®Ø·ÙŠØ· Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
            display: grid; grid-template-columns: 1fr 350px;
            width: 100%; height: 100%; gap: 20px; padding: 20px;
            opacity: 0; transition: opacity 0.5s ease;
            visibility: hidden; pointer-events: none; z-index: 2;
        }
        .game-container.visible { opacity: 1; visibility: visible; pointer-events: all; }
        
        .game-table-area { 
            position: relative; 
            display: flex; justify-content: center; align-items: center; 
            height: 100%; width: 100%; 
            /* ÙŠØ¶Ù…Ù† Ø¹Ø¯Ù… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ù‡ */
            overflow: hidden;
        }
        
        #game-table {
            /* Ø§Ø³ØªØ®Ø¯Ø§Ù… vmin ÙŠØ¬Ø¹Ù„ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© ØªØ³ØªØ¬ÙŠØ¨ Ù„Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø£ØµØºØ± (Ø§Ù„Ø¹Ø±Ø¶ Ø£Ùˆ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹) */
            width: 85vmin; height: 85vmin;
            max-width: 700px; max-height: 700px;
            background: radial-gradient(circle, #3a2a1a 0%, #1c140d 70%);
            border-radius: 50%; border: 15px solid #4a3a2a;
            box-shadow: 0 0 60px rgba(0,0,0,0.8), inset 0 0 100px rgba(0,0,0,0.9);
            position: relative; transition: box-shadow 1s ease;
        }
        
        #game-table::before {
            content: 'M'; font-family: 'Cinzel Decorative', cursive;
            font-size: 18vmin; color: rgba(139, 0, 0, 0.4);
            text-shadow: 0 0 20px rgba(139, 0, 0, 0.5);
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            animation: pulse-glow 4s infinite ease-in-out;
            pointer-events: none;
            transition: color 1s ease, text-shadow 1s ease;
        }
        @keyframes pulse-glow { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; text-shadow: 0 0 30px rgba(139, 0, 0, 0.8); } }
        
        .player-seat {
            position: absolute; 
            /* Ø­Ø¬Ù… Ù…ØªØ¬Ø§ÙˆØ¨ Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
            width: clamp(70px, 12vmin, 100px);
            height: clamp(70px, 12vmin, 100px);
            background: rgba(10, 10, 10, 0.7);
            border-radius: 50%; border: 3px solid rgba(240, 230, 210, 0.3);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 5px; transition: all 0.5s ease;
        }
        
        .player-status { font-size: clamp(24px, 5vmin, 30px); line-height: 1; }
        .player-name { 
            font-size: clamp(14px, 2.5vmin, 18px); 
            font-family: 'Cinzel Decorative', cursive; color: var(--primary-text); 
            text-shadow: 1px 1px 5px #000; white-space: nowrap; overflow: hidden; 
            text-overflow: ellipsis; width: 100%; text-align: center; 
        }
        
        .player-seat.clickable { cursor: pointer; }
        .player-seat.clickable:hover { border-color: var(--primary-text); transform: scale(1.1) !important; box-shadow: 0 0 20px rgba(240, 230, 210, 0.5); }
        .player-seat--eliminated { opacity: 0.4; pointer-events: none; background: #333; }
        .player-seat--speaking { border-color: var(--primary-red); box-shadow: 0 0 25px rgba(139, 0, 0, 0.9); transform: scale(1.1) !important; }
        
        .log-panel { 
            background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); 
            border: 1px solid rgba(139, 0, 0, 0.3); border-radius: 15px; 
            padding: 20px; display: flex; flex-direction: column; 
            overflow: hidden; 
            /* Ø§Ù†ØªÙ‚Ø§Ù„ Ø³Ù„Ø³ Ù„Ù„Ø­Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
            transition: transform 0.4s ease-in-out;
        }

        .game-log { flex: 1; overflow-y: auto; display: flex; flex-direction: column-reverse; padding-right: 10px; }
        .log-message { margin-bottom: 15px; padding: 15px 20px; border-radius: 8px; opacity: 0; animation: fadeIn 0.5s ease forwards; font-family: 'Lateef', serif; font-size: 24px; line-height: 1.6; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); transition: opacity 0.3s ease; }
        .modal.visible { display: flex; }
        .modal-content { background: linear-gradient(145deg, #2a2a2a, #1a1a1a); border: 2px solid var(--primary-red); border-radius: 20px; padding: 40px; text-align: center; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7); }
        .modal-button { background: linear-gradient(145deg, var(--primary-red), #6B0000); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-family: 'Cinzel Decorative', cursive; font-size: 16px; cursor: pointer; transition: all 0.3s ease; margin-top: 20px; }
        
        @keyframes revealCard { from { transform: translateY(100vh) rotateY(-180deg); opacity: 0; } to { transform: translateY(0) rotateY(0deg); opacity: 1; } }
        #role-card-modal .modal-content { animation: revealCard 0.8s ease-out forwards; }
        
        .room-info { padding: 10px; text-align: center; border-bottom: 1px solid rgba(139, 0, 0, 0.3); margin-bottom: 10px; display: flex; justify-content: center; align-items: center; gap: 10px; font-size: 20px;}
        #copy-room-id-btn { background: #444; color: #fff; border: 1px solid #666; padding: 5px 10px; cursor: pointer; border-radius: 5px;}
        
        .turn-indicator { padding: 15px; text-align: center; border-top: 1px solid rgba(139, 0, 0, 0.3); margin-top: 15px; }
        .turn-indicator.hidden { display: none; }
        .turn-timer { font-size: 48px; font-family: 'Cinzel Decorative', cursive; color: var(--primary-red); margin-bottom: 10px; }
        .turn-player { font-size: 28px; margin-bottom: 15px; font-family: 'Lateef', serif; }
        .skip-turn-btn { background: transparent; border: 1px solid var(--primary-text); color: var(--primary-text); padding: 8px 20px; cursor: pointer; font-family: 'Lateef', serif; font-size: 22px; transition: all 0.3s; border-radius: 5px;}
        
        #panel-toggle-btn { display: none; /* ÙŠØªÙ… Ø¥Ø¸Ù‡Ø§Ø±Ù‡ Ø¨Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ ÙƒÙˆÙŠØ±ÙŠ */ }

        /* --- MEDIA QUERIES FOR RESPONSIVE DESIGN --- */
        /* Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆØ§Ù„ØªØ§Ø¨Ù„Øª Ø§Ù„ØµØºÙŠØ±Ø© (Ø£Ù‚Ù„ Ù…Ù† 900 Ø¨ÙƒØ³Ù„) */
        @media (max-width: 900px) {
            .game-container {
                /* ØªØºÙŠÙŠØ± Ø§Ù„ØªØ®Ø·ÙŠØ· Ù„ÙŠØµØ¨Ø­ Ø¹Ù…ÙˆØ¯ÙŠØ§Ù‹ ÙˆÙŠÙ…Ù„Ø£ Ø§Ù„Ø´Ø§Ø´Ø© */
                grid-template-columns: 1fr;
                grid-template-rows: 1fr; 
                padding: 10px;
                gap: 0;
            }

            .log-panel {
                /* ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù„ÙˆØ­Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø¬Ø§Ù†Ø¨ÙŠØ© Ù…Ù†Ø³Ø¯Ù„Ø© */
                position: fixed;
                top: 0;
                right: 0;
                transform: translateX(100%); /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù„ÙˆØ­Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø§Ø´Ø© */
                width: var(--panel-width-mobile);
                max-width: 85%;
                height: 100%;
                z-index: 40;
                border-radius: 0;
                border-left: 2px solid rgba(139, 0, 0, 0.5);
                border-right: none;
            }

            .log-panel.open {
                transform: translateX(0); /* Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù„ÙˆØ­Ø© */
            }

            #panel-toggle-btn {
                display: flex; justify-content: center; align-items: center;
                position: fixed;
                top: 50%;
                right: 0;
                transform: translateY(-50%);
                width: 30px; height: 80px;
                background: rgba(139,0,0,0.7);
                border: 1px solid #ff0000; color: white;
                border-radius: 10px 0 0 10px;
                font-size: 24px;
                cursor: pointer;
                z-index: 50;
                transition: transform 0.4s ease-in-out;
            }

            #panel-toggle-btn.open {
                /* ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø²Ø± Ù…Ø¹ Ø§Ù„Ù„ÙˆØ­Ø© */
                transform: translateY(-50%) translateX(calc(-1 * var(--panel-width-mobile)));
            }

            #game-table { width: 90vw; height: 90vw; }
            .player-name { font-size: 14px; }
            .log-message { font-size: 20px; }
            .turn-player { font-size: 24px; }
            .turn-timer { font-size: 40px; }
        }
    </style>
</head>
<body>
    <video autoplay muted loop id="bg-video">
        <source src="videos/bg-video.mp4" type="video/mp4">
    </video>

    <div class="setup-container" id="setup-container">
        <div class="setup-box">
            <h1>Ø·Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø§ÙÙŠØ§</h1>
            <div class="form-group">
                <label for="player-name-input">Ø§Ø³Ù…Ùƒ</label>
                <input type="text" id="player-name-input">
            </div>
            <div class="mode-selector">
                <button class="mode-btn active" id="create-btn">Ø¥Ù†Ø´Ø§Ø¡ Ù„Ø¹Ø¨Ø©</button>
                <button class="mode-btn" id="join-btn">Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¹Ø¨Ø©</button>
            </div>
            <div id="create-options">
                <div class="form-group slider-group">
                    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:</label>
                    <input type="range" id="player-count-slider" min="4" max="12" value="4">
                    <span id="player-count-display">4</span>
                </div>
                <div class="form-group roles-config">
                    <h3>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± (<span id="total-roles">0</span>/<span id="needed-roles">4</span>)</h3>
                    <div id="roles-list"></div>
                </div>
            </div>
            <div id="join-options">
                <div class="form-group">
                    <label for="room-id-input">ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©</label>
                    <input type="text" id="room-id-input">
                </div>
            </div>
            <button id="final-action-btn">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
        </div>
    </div>
    
    <div class="game-container" id="game-container">
        <div class="game-table-area" id="game-table-area">
            <div id="game-table"></div>
        </div>
        <div class="log-panel" id="log-panel">
            <div id="game-controls">
                 <div class="room-info" id="room-info-display" style="display: none;">
                    <span>ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©: <strong id="room-id-text"></strong></span>
                    <button id="copy-room-id-btn">Ù†Ø³Ø®</button>
                </div>
                <div style="text-align: center;">
                    <button id="start-game-btn-ingame" class="modal-button" style="display: none; margin-top: 0; margin-bottom: 10px;">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
                </div>
            </div>
            <div class="game-log">
                <div class="log-content" id="log-content"></div>
            </div>
            <div id="turn-indicator" class="turn-indicator hidden"></div>
        </div>
    </div>
    
    <button id="panel-toggle-btn">&#9664;</button>

    <div id="game-over-modal" class="modal">
        <div class="modal-content">
            <h2 id="game-over-title">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!</h2>
            <p id="game-over-message"></p>
            <button id="exit-to-menu-btn" class="modal-button">Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>
    </div>

    <div id="role-card-modal" class="modal">
        <div class="modal-content">
            <h2 id="role-title"></h2>
            <span id="role-icon" style="font-size: 80px; margin-bottom: 20px; display: block;"></span>
            <p id="role-description"></p>
            <button id="close-role-card-btn" class="modal-button">ÙÙ‡Ù…Øª</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 1. ELEMENT DECLARATIONS ---
        const socket = io();
        const setupContainer = document.getElementById('setup-container');
        const playerNameInput = document.getElementById('player-name-input');
        const roomIdInput = document.getElementById('room-id-input');
        const createBtn = document.getElementById('create-btn');
        const joinBtn = document.getElementById('join-btn');
        const createOptions = document.getElementById('create-options');
        const joinOptions = document.getElementById('join-options');
        const finalActionBtn = document.getElementById('final-action-btn');
        const playerCountSlider = document.getElementById('player-count-slider');
        const playerCountDisplay = document.getElementById('player-count-display');
        const rolesList = document.getElementById('roles-list');
        const totalRolesSpan = document.getElementById('total-roles');
        const neededRolesSpan = document.getElementById('needed-roles');
        const gameContainer = document.getElementById('game-container');
        const startGameBtnIngame = document.getElementById('start-game-btn-ingame');
        const closeRoleCardBtn = document.getElementById('close-role-card-btn');
        const gameOverModal = document.getElementById('game-over-modal');
        const exitToMenuBtn = document.getElementById('exit-to-menu-btn');
        const roomInfoDisplay = document.getElementById('room-info-display');
        const roomIdText = document.getElementById('room-id-text');
        const copyRoomIdBtn = document.getElementById('copy-room-id-btn');
        const panelToggleBtn = document.getElementById('panel-toggle-btn');
        const logPanel = document.getElementById('log-panel');
        
        const availableRoles = ['Ø§Ù„Ù…Ø§ÙÙŠØ§', 'Ø§Ù„Ù…Ø­Ù‚Ù‚', 'Ø§Ù„Ø·Ø¨ÙŠØ¨', 'Ù…ÙˆØ§Ø·Ù†'];
        let roleCounts = {};
        let localStream;
        let peerConnections = {};
        let currentRoomId = null;

        // --- 2. SETUP SCREEN LOGIC ---
        function initializeSetup() {
            createOptions.style.display = 'block';
            joinOptions.style.display = 'none';
            finalActionBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©';
            roleCounts = {};
            availableRoles.forEach(role => {
                roleCounts[role] = (role === 'Ø§Ù„Ù…Ø§ÙÙŠØ§' || role === 'Ø§Ù„Ù…Ø­Ù‚Ù‚' || role === 'Ø§Ù„Ø·Ø¨ÙŠØ¨') ? 1 : 0;
            });
            roleCounts['Ù…ÙˆØ§Ø·Ù†'] = parseInt(playerCountSlider.value) - 3;
            renderRoles();
            updateRoleValidation();
        }
        
        function renderRoles() {
            rolesList.innerHTML = '';
            availableRoles.forEach(role => {
                const item = document.createElement('div');
                item.className = 'role-item';
                item.innerHTML = `<span class="role-name">${role}</span><div class="role-controls"><button class="role-btn" data-role="${role}" data-action="minus">-</button><span class="role-count" id="count-${role}">${roleCounts[role]}</span><button class="role-btn" data-role="${role}" data-action="plus">+</button></div>`;
                rolesList.appendChild(item);
            });
        }

        function updateRoleCount(role, action) {
            if (action === 'plus') { roleCounts[role]++; } 
            else if (action === 'minus' && roleCounts[role] > 0) { roleCounts[role]--; }
            document.getElementById(`count-${role}`).textContent = roleCounts[role];
            updateRoleValidation();
        }

        function updateRoleValidation() {
            const playerCount = parseInt(playerCountSlider.value);
            const totalRoles = Object.values(roleCounts).reduce((a, b) => a + b, 0);
            totalRolesSpan.textContent = totalRoles;
            neededRolesSpan.textContent = playerCount;
            if (totalRoles === playerCount) {
                finalActionBtn.disabled = false;
                totalRolesSpan.style.color = '#00ff00';
            } else {
                finalActionBtn.disabled = true;
                totalRolesSpan.style.color = '#ff0000';
            }
        }
        
        createBtn.addEventListener('click', () => {
            createBtn.classList.add('active'); joinBtn.classList.remove('active');
            createOptions.style.display = 'block'; joinOptions.style.display = 'none';
            finalActionBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©';
            updateRoleValidation();
        });

        joinBtn.addEventListener('click', () => {
            joinBtn.classList.add('active'); createBtn.classList.remove('active');
            joinOptions.style.display = 'block'; createOptions.style.display = 'none';
            finalActionBtn.textContent = 'Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¹Ø¨Ø©';
            finalActionBtn.disabled = false;
        });

        playerCountSlider.addEventListener('input', (e) => {
            const count = e.target.value;
            playerCountDisplay.textContent = count;
            const specialRoles = Object.keys(roleCounts).filter(r => r !== 'Ù…ÙˆØ§Ø·Ù†').reduce((sum, role) => sum + roleCounts[role], 0);
            roleCounts['Ù…ÙˆØ§Ø·Ù†'] = count - specialRoles;
            if (roleCounts['Ù…ÙˆØ§Ø·Ù†'] < 0) roleCounts['Ù…ÙˆØ§Ø·Ù†'] = 0;
            if(document.getElementById('count-Ù…ÙˆØ§Ø·Ù†')) document.getElementById('count-Ù…ÙˆØ§Ø·Ù†').textContent = roleCounts['Ù…ÙˆØ§Ø·Ù†'];
            updateRoleValidation();
        });

        rolesList.addEventListener('click', (e) => {
            if (e.target.classList.contains('role-btn')) {
                updateRoleCount(e.target.dataset.role, e.target.dataset.action);
            }
        });

        finalActionBtn.addEventListener('click', () => {
            const playerName = playerNameInput.value.trim();
            if (!playerName) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ.');
            
            if (createBtn.classList.contains('active')) {
                const settings = {
                    playerCount: parseInt(playerCountSlider.value),
                    roles: roleCounts,
                    speakingTime: 60,
                    votingTime: 30,
                };
                socket.emit('create-game', playerName, settings);
            } else {
                const roomId = roomIdInput.value.trim().toUpperCase();
                if (!roomId) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©.');
                socket.emit('join-room', roomId, playerName);
            }
        });
        
        copyRoomIdBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(roomIdText.textContent).then(() => {
                alert('ØªÙ… Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©!');
            });
        });

        exitToMenuBtn.addEventListener('click', () => { window.location.reload(); });
        closeRoleCardBtn.addEventListener('click', () => { document.getElementById('role-card-modal').classList.remove('visible'); });

        startGameBtnIngame.addEventListener('click', () => {
            if (currentRoomId) {
                socket.emit('start-game', currentRoomId);
            }
        });
        
        panelToggleBtn.addEventListener('click', () => {
            logPanel.classList.toggle('open');
            panelToggleBtn.classList.toggle('open');
            if (logPanel.classList.contains('open')) {
                panelToggleBtn.innerHTML = '&#9654;'; // Right arrow
            } else {
                panelToggleBtn.innerHTML = '&#9664;'; // Left arrow
            }
        });

        // --- 3. SOCKET.IO & GAME HANDLERS ---
        socket.on('game-created', (roomId) => {
            const playerName = playerNameInput.value.trim();
            socket.emit('join-room', roomId, playerName);
        });

       socket.on('joined-successfully', (roomId) => {
            currentRoomId = roomId;
            navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                .then(stream => {
                    localStream = stream;
                    setupContainer.classList.add('hidden');
                    gameContainer.classList.add('visible');
                    roomInfoDisplay.style.display = 'flex';
                    roomIdText.textContent = roomId;
                }).catch(err => alert("ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†."));
        });
        
        socket.on('error-message', (message) => { alert(message); });
        
        socket.on('game-over', (message) => {
            deactivatePlayerButtons();
            document.getElementById('game-over-message').textContent = message;
            gameOverModal.classList.add('visible');
        });

        socket.on('update-room-info', (roomInfo) => {
            const { players, hostId, gameState, settings } = roomInfo;
            // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„Ù€ layout ÙØ±ØµØ© Ù„Ù„ØªØ­Ø¯ÙŠØ« Ù‚Ø¨Ù„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
            setTimeout(() => setupGameBoard(players.map(p => p.name)), 100);
            
            if (socket.id === hostId && players.length >= (settings ? settings.playerCount : 0) && !gameState) {
                startGameBtnIngame.style.display = 'block';
            } else {
                startGameBtnIngame.style.display = 'none';
            }
        });
        
        let soundQueue = [];
        let isSoundPlaying = false;
        
        function processSoundQueue() {
            if (isSoundPlaying || soundQueue.length === 0) return;
            isSoundPlaying = true;
            const soundFile = soundQueue.shift();
            const audio = new Audio(`/sounds/${soundFile}`);
            audio.play().catch(e => console.error("Error playing sound:", e));
            audio.onended = () => { isSoundPlaying = false; processSoundQueue(); };
            audio.onerror = () => { isSoundPlaying = false; processSoundQueue(); };
        }
        
        function addLogMessage(message, type = 'narrative') {
            const logContent = document.getElementById('log-content');
            const messageElement = document.createElement('div');
            messageElement.className = `log-message log-${type}`;
            messageElement.textContent = message;
            logContent.insertBefore(messageElement, logContent.firstChild);
        }

        function setMuteState(isMuted) {
            if (localStream) {
                localStream.getAudioTracks().forEach(track => { track.enabled = !isMuted; });
            }
        }
        
        function setupGameBoard(playerNamesArray) {
            const tableArea = document.getElementById('game-table-area');
            let table = document.getElementById('game-table');
            if (!table) {
                tableArea.innerHTML = '<div id="game-table"></div>'; 
                table = document.getElementById('game-table');
            }
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            document.querySelectorAll('.player-seat').forEach(seat => seat.remove());

            playerNamesArray.forEach((playerName, i) => {
                const angle = (i / playerNamesArray.length) * 2 * Math.PI - (Math.PI / 2);
                const radius = table.offsetWidth / 2.2; // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù†ØµÙ Ù‚Ø·Ø± Ù‚Ù„ÙŠÙ„Ø§ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø­ÙˆØ§Ù
                const x = radius * Math.cos(angle);
                const y = radius * Math.sin(angle);

                const seat = document.createElement('div');
                seat.className = 'player-seat';
                seat.dataset.playerName = playerName;
                // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù€ transform Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ±
                seat.style.position = 'absolute';
                seat.style.top = `calc(50% + ${y}px)`;
                seat.style.left = `calc(50% + ${x}px)`;
                seat.style.transform = `translate(-50%, -50%)`;
                
                seat.innerHTML = `<span class="player-status">ğŸ‘¤</span><span class="player-name">${playerName}</span>`;
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø¹Ø¯ Ø¥Ù„Ù‰ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø·Ø§ÙˆÙ„Ø© ÙˆÙ„ÙŠØ³ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù†ÙØ³Ù‡Ø§
                tableArea.appendChild(seat);
            });
        }
        
        function activatePlayerButtons(callback) {
            document.querySelectorAll('.player-seat').forEach(seat => {
                if (!seat.classList.contains('player-seat--eliminated')) {
                    seat.classList.add('clickable');
                    seat.onclick = () => callback(seat.dataset.playerName);
                }
            });
        }

        function deactivatePlayerButtons() {
            document.querySelectorAll('.player-seat').forEach(seat => {
                seat.classList.remove('clickable');
                seat.onclick = null;
            });
        }

        socket.on('receive-role', (roleInfo) => {
            const roleCardModal = document.getElementById('role-card-modal');
            document.getElementById('role-title').textContent = roleInfo.title;
            document.getElementById('role-icon').textContent = roleInfo.icon;
            document.getElementById('role-description').textContent = roleInfo.description;
            roleCardModal.classList.add('visible');
        });
        
        socket.on('game-update', (data) => {
            switch(data.event) {
                case 'log': addLogMessage(data.message, data.type); break;
                case 'set-theme': document.body.classList.toggle('theme-day', data.theme === 'day'); break;
                case 'play-sound': soundQueue.push(data.file); processSoundQueue(); break;
            }
        });

        let speakerTimerInterval;
        socket.on('start-speaker-turn', ({ speakerName, time }) => {
            document.querySelectorAll('.player-seat--speaking').forEach(el => el.classList.remove('player-seat--speaking'));
            const speakerSeat = document.querySelector(`[data-player-name="${speakerName}"]`);
            if (speakerSeat) speakerSeat.classList.add('player-seat--speaking');
            const turnIndicator = document.getElementById('turn-indicator');
            turnIndicator.classList.remove('hidden');
            let timeLeft = parseInt(time);
            turnIndicator.innerHTML = `
                <div class="turn-player">Ø¯ÙˆØ± ${speakerName} Ù„Ù„ÙƒÙ„Ø§Ù…...</div>
                <div class="turn-timer">${timeLeft}</div>
                <button id="skip-turn-btn" class="modal-button" style="margin-top:10px;">ØªØ®Ø·ÙŠ Ø§Ù„Ø¯ÙˆØ±</button>
            `;
            document.getElementById('skip-turn-btn').onclick = () => {
                socket.emit('skip-speaker-turn', currentRoomId);
            };
            clearInterval(speakerTimerInterval);
            speakerTimerInterval = setInterval(() => {
                timeLeft--;
                const timerEl = turnIndicator.querySelector('.turn-timer');
                if (timerEl) timerEl.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(speakerTimerInterval);
                }
            }, 1000);
        });

        socket.on('perform-night-action', ({ prompt, canChooseSelf }) => {
            addLogMessage(prompt, 'alert');
            activatePlayerButtons((chosenPlayer) => {
                if (!canChooseSelf && chosenPlayer === playerNameInput.value.trim()) {
                    addLogMessage('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙØ³Ùƒ.', 'system'); return;
                }
                deactivatePlayerButtons();
                socket.emit('submit-night-action', currentRoomId, chosenPlayer);
            });
        });

        socket.on('perform-vote', () => {
            document.getElementById('turn-indicator').classList.add('hidden');
            activatePlayerButtons((chosenPlayer) => {
                deactivatePlayerButtons();
                socket.emit('submit-vote', currentRoomId, chosenPlayer);
            });
        });
        
        socket.on('player-eliminated', (playerName) => {
            const seat = document.querySelector(`[data-player-name="${playerName}"]`);
            if (seat) {
                seat.classList.add('player-seat--eliminated');
                seat.querySelector('.player-status').textContent = 'ğŸ’€';
            }
        });

        socket.on('mute-all', () => setMuteState(true));
        socket.on('unmute-all', () => setMuteState(false));
        socket.on('enter-mafia-channel', (mafiaSocketIds) => {
            if (mafiaSocketIds.includes(socket.id)) setMuteState(false); else setMuteState(true);
        });
        socket.on('exit-mafia-channel', () => setMuteState(true));

        socket.on('user-joined', (newSocketId) => createPeerConnection(newSocketId, true));
        socket.on('user-left', (socketId) => {
            if (peerConnections[socketId]) { peerConnections[socketId].close(); delete peerConnections[socketId]; }
            const audioEl = document.getElementById(`audio-${socketId}`);
            if (audioEl) audioEl.remove();
        });
        socket.on('offer', (senderSocketId, offer) => {
            createPeerConnection(senderSocketId, false);
            peerConnections[senderSocketId].setRemoteDescription(new RTCSessionDescription(offer))
                .then(() => peerConnections[senderSocketId].createAnswer())
                .then(answer => {
                    peerConnections[senderSocketId].setLocalDescription(answer);
                    socket.emit('answer', senderSocketId, answer);
                });
        });
        socket.on('answer', (senderSocketId, answer) => peerConnections[senderSocketId].setRemoteDescription(new RTCSessionDescription(answer)));
        socket.on('ice-candidate', (senderSocketId, candidate) => {
            if (peerConnections[senderSocketId]) peerConnections[senderSocketId].addIceCandidate(new RTCIceCandidate(candidate));
        });

        function createPeerConnection(targetSocketId, isInitiator) {
            if (peerConnections[targetSocketId]) return;
            peerConnections[targetSocketId] = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            if(localStream) {
                localStream.getTracks().forEach(track => peerConnections[targetSocketId].addTrack(track, localStream));
            }
            peerConnections[targetSocketId].ontrack = (event) => {
                let audio = document.getElementById(`audio-${targetSocketId}`);
                if (!audio) {
                    audio = document.createElement('audio');
                    audio.id = `audio-${targetSocketId}`;
                    audio.autoplay = true;
                    document.body.appendChild(audio);
                }
                audio.srcObject = event.streams[0];
            };
            peerConnections[targetSocketId].onicecandidate = (event) => {
                if (event.candidate) socket.emit('ice-candidate', targetSocketId, event.candidate);
            };
            if (isInitiator) {
                peerConnections[targetSocketId].createOffer()
                    .then(offer => peerConnections[targetSocketId].setLocalDescription(offer))
                    .then(() => socket.emit('offer', targetSocketId, peerConnections[targetSocketId].localDescription));
            }
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø©
        window.addEventListener('resize', () => {
            if (currentRoomId) {
                // Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                // Ù„ÙƒÙ† ÙƒØ­Ù„ Ø¨Ø³ÙŠØ·ØŒ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù…Ù‡Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…ÙˆØ¬ÙˆØ¯Ø©
                const players = Array.from(document.querySelectorAll('.player-seat')).map(seat => seat.dataset.playerName);
                if (players.length > 0) {
                    setupGameBoard(players);
                }
            }
        });

        initializeSetup();
    });
    </script>
</body>
</html>