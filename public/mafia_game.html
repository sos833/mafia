<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ŸÑÿπÿ®ÿ© ÿßŸÑŸÖÿßŸÅŸäÿß - ÿßŸÑÿ∑ÿßŸàŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿØŸäÿ±ÿ©</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Lateef&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: 'Lateef', serif;
            background: #000;
            color: #f0e6d2;
            display: flex; justify-content: center; align-items: center;
        }
        #bg-video {
            position: fixed; right: 0; bottom: 0;
            min-width: 100%; min-height: 100%;
            z-index: -2; opacity: 0.3; object-fit: cover;
        }
        body::before {
            content: ''; position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle, transparent 20%, black 100%);
            z-index: -1;
        }
        .setup-container {
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            padding: 20px;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 100;
            position: fixed; top: 0; left: 0;
            transition: opacity 0.5s ease, visibility 0.5s;
        }
        .setup-container.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .setup-box {
            background: rgba(10,10,10,0.8);
            border: 2px solid #8B0000;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px; width: 100%;
            box-shadow: 0 0 30px rgba(139,0,0,0.5);
        }
        .setup-box h1 {
            font-family: 'Cinzel Decorative', cursive;
            color: #8B0000; font-size: 42px; text-align: center;
            margin-bottom: 25px;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block; font-size: 24px; margin-bottom: 8px;
            font-family: 'Cinzel Decorative', cursive;
        }
        .form-group input[type="text"], .form-group input[type="number"] {
            width: 100%;
            background: rgba(0,0,0,0.5);
            border: 1px solid #555;
            border-radius: 8px;
            padding: 12px;
            color: #f0e6d2;
            font-family: 'Lateef', serif;
            font-size: 22px;
        }
        .mode-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-btn {
            flex: 1; padding: 10px; font-size: 20px;
            font-family: 'Cinzel Decorative', cursive;
            background: #333; border: 1px solid #555; color: #aaa;
            cursor: pointer; transition: all 0.3s;
        }
        .mode-btn.active { background: #8B0000; border-color: #ff0000; color: white; }
        #create-options, #join-options { display: none; }
        .slider-group { display: flex; align-items: center; gap: 15px; }
        input[type="range"] { flex: 1; -webkit-appearance: none; background: #444; height: 8px; border-radius: 4px; outline: none;}
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #8B0000; border-radius: 50%; cursor: pointer; border: 2px solid #ff0000;}
        #player-count-display { font-size: 24px; font-weight: bold; color: #8B0000; }
        .roles-config h3 { font-size: 26px; margin-bottom: 10px; font-family: 'Cinzel Decorative', cursive;}
        .role-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 5px; background: rgba(255,255,255,0.05); border-radius: 5px; }
        .role-name { font-size: 22px; }
        .role-controls { display: flex; align-items: center; gap: 10px; }
        .role-btn {
            width: 30px; height: 30px; border-radius: 50%;
            background: #555; color: white; border: none;
            font-size: 20px; font-weight: bold; cursor: pointer;
        }
        .role-count { font-size: 22px; width: 30px; text-align: center; }
        #final-action-btn {
            width: 100%; padding: 15px; font-size: 24px;
            margin-top: 20px;
            background: linear-gradient(145deg, #8B0000, #6B0000);
            border: none; color: white; border-radius: 8px;
            font-family: 'Cinzel Decorative', cursive; cursor: pointer;
        }
        #final-action-btn:disabled { background: #555; cursor: not-allowed; opacity: 0.6; }

        .game-container {
            display: grid; grid-template-columns: 1fr 400px;
            width: 100%; height: 100%; gap: 20px; padding: 20px;
            opacity: 0; transition: opacity 0.5s ease, visibility 0.5s;
            visibility: hidden; pointer-events: none; z-index: 2;
        }
        .game-container.visible { opacity: 1; visibility: visible; pointer-events: all; }
        .game-table-area { position: relative; display: flex; justify-content: center; align-items: center; height: 100%; width: 100%; }
        #game-table {
            width: 90vmin; height: 90vmin;
            max-width: 800px; max-height: 800px;
            background: radial-gradient(circle, #3a2a1a 0%, #1c140d 70%);
            border-radius: 50%; border: 15px solid #4a3a2a;
            box-shadow: 0 0 60px rgba(0,0,0,0.8), inset 0 0 100px rgba(0,0,0,0.9);
            position: relative; transition: box-shadow 1s ease;
        }
        #game-table::before {
            content: 'M';
            font-family: 'Cinzel Decorative', cursive;
            font-size: 18vmin;
            color: rgba(139, 0, 0, 0.4);
            text-shadow: 0 0 20px rgba(139, 0, 0, 0.5);
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            animation: pulse-glow 4s infinite ease-in-out;
            pointer-events: none;
            transition: color 1s ease, text-shadow 1s ease;
        }
        @keyframes pulse-glow { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; text-shadow: 0 0 30px rgba(139, 0, 0, 0.8); } }
        .player-seat {
            position: absolute; width: 100px; height: 100px;
            background: rgba(10, 10, 10, 0.7);
            border-radius: 50%; border: 3px solid rgba(240, 230, 210, 0.3);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 10px; transition: all 0.5s ease;
        }
        .player-status { font-size: 30px; line-height: 1; }
        .player-name { font-size: 20px; font-family: 'Cinzel Decorative', cursive; color: #f0e6d2; text-shadow: 1px 1px 5px #000; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; text-align: center; }
        .player-seat.clickable { cursor: pointer; }
        .player-seat.clickable:hover { border-color: #f0e6d2; transform: scale(1.1); box-shadow: 0 0 20px rgba(240, 230, 210, 0.5); }
        .player-seat--eliminated { opacity: 0.4; pointer-events: none; background: #333; }
        .player-seat--speaking { border-color: #8B0000; box-shadow: 0 0 25px rgba(139, 0, 0, 0.9); transform: scale(1.1); }
        .log-panel { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); border: 1px solid rgba(139, 0, 0, 0.3); border-radius: 15px; padding: 20px; display: flex; flex-direction: column; overflow: hidden; }
        .game-log { flex: 1; overflow-y: auto; display: flex; flex-direction: column-reverse; padding-right: 10px; }
        .log-message { margin-bottom: 15px; padding: 15px 20px; border-radius: 8px; opacity: 0; animation: fadeIn 0.5s ease forwards; font-family: 'Lateef', serif; font-size: 24px; line-height: 1.6; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); transition: opacity 0.3s ease; }
        .modal.visible { display: flex; }
        .modal-content { background: linear-gradient(145deg, #2a2a2a, #1a1a1a); border: 2px solid #8B0000; border-radius: 20px; padding: 40px; text-align: center; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7); }
        .modal-button { background: linear-gradient(145deg, #8B0000, #6B0000); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-family: 'Cinzel Decorative', cursive; font-size: 16px; cursor: pointer; transition: all 0.3s ease; margin-top: 20px; }
        @keyframes revealCard { from { transform: translateY(100vh) rotateY(-180deg); opacity: 0; } to { transform: translateY(0) rotateY(0deg); opacity: 1; } }
        #role-card-modal .modal-content { animation: revealCard 0.8s ease-out forwards; }
        .room-info { padding: 10px; text-align: center; border-bottom: 1px solid rgba(139, 0, 0, 0.3); margin-bottom: 10px; display: flex; justify-content: center; align-items: center; gap: 10px; font-size: 20px;}
        #copy-room-id-btn { background: #444; color: #fff; border: 1px solid #666; padding: 5px 10px; cursor: pointer; border-radius: 5px;}
        .turn-indicator { padding: 15px; text-align: center; border-top: 1px solid rgba(139, 0, 0, 0.3); margin-top: 15px; }
        .turn-indicator.hidden { display: none; }
        .turn-timer { font-size: 48px; font-family: 'Cinzel Decorative', cursive; color: #8B0000; margin-bottom: 10px; }
        .turn-player { font-size: 28px; margin-bottom: 15px; font-family: 'Lateef', serif; }
        .skip-turn-btn { background: transparent; border: 1px solid #f0e6d2; color: #f0e6d2; padding: 8px 20px; cursor: pointer; font-family: 'Lateef', serif; font-size: 22px; transition: all 0.3s; border-radius: 5px;}
        #panel-toggle-btn { display: none; }

        @media (max-width: 800px) {
            .game-container { grid-template-columns: 1fr; grid-template-rows: 1fr; padding: 0; gap: 0; }
            .log-panel {
                position: fixed; top: 0; right: -100%;
                width: 80%; max-width: 350px; height: 100%;
                z-index: 40; border-radius: 0; border-right: none; border-left: 2px solid rgba(139, 0, 0, 0.5);
                transition: right 0.5s ease-in-out;
            }
            .log-panel.open { right: 0; }
            #panel-toggle-btn {
                display: flex; justify-content: center; align-items: center;
                position: fixed; top: 50%; right: 0;
                transform: translateY(-50%);
                width: 30px; height: 80px;
                background: rgba(139,0,0,0.7);
                border: 1px solid #ff0000; color: white;
                border-radius: 10px 0 0 10px;
                font-size: 24px; cursor: pointer; z-index: 50;
                transition: right 0.5s ease-in-out;
            }
            #panel-toggle-btn.open { right: 80%; max-width: 350px; }
            #game-table { width: 90vw; height: 90vw; }
            .player-seat { width: 70px; height: 70px; }
            .player-name { font-size: 14px; }
        }
    </style>
</head>
<body>
    <video autoplay muted loop id="bg-video">
        <source src="videos/bg-video.mp4" type="video/mp4">
    </video>

    <div class="setup-container" id="setup-container">
        <div class="setup-box">
            <h1>ÿ∑ÿßŸàŸÑÿ© ÿßŸÑŸÖÿßŸÅŸäÿß</h1>
            <div class="form-group">
                <label for="player-name-input">ÿßÿ≥ŸÖŸÉ</label>
                <input type="text" id="player-name-input">
            </div>
            <div class="mode-selector">
                <button class="mode-btn active" id="create-btn">ÿ•ŸÜÿ¥ÿßÿ° ŸÑÿπÿ®ÿ©</button>
                <button class="mode-btn" id="join-btn">ÿßŸÑÿßŸÜÿ∂ŸÖÿßŸÖ ŸÑŸÑÿπÿ®ÿ©</button>
            </div>
            <div id="create-options">
                <div class="form-group slider-group">
                    <label>ÿπÿØÿØ ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ:</label>
                    <input type="range" id="player-count-slider" min="4" max="12" value="4">
                    <span id="player-count-display">4</span>
                </div>
                <div class="form-group roles-config">
                    <h3>ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ£ÿØŸàÿßÿ± (<span id="total-roles">0</span>/<span id="needed-roles">4</span>)</h3>
                    <div id="roles-list"></div>
                </div>
            </div>
            <div id="join-options">
                <div class="form-group">
                    <label for="room-id-input">ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ©</label>
                    <input type="text" id="room-id-input">
                </div>
            </div>
            <button id="final-action-btn">ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÑÿπÿ®ÿ©</button>
        </div>
    </div>
    
    <div class="game-container" id="game-container">
        <div class="game-table-area" id="game-table-area">
            <div id="game-table"></div>
        </div>
     <div class="log-panel open" id="log-panel">
            <div id="game-controls">
                 <div class="room-info" id="room-info-display" style="display: none;">
                    <span>ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ©: <strong id="room-id-text"></strong></span>
                    <button id="copy-room-id-btn">ŸÜÿ≥ÿÆ</button>
                </div>
                <div style="text-align: center;">
                    <button id="start-game-btn-ingame" class="modal-button" style="display: none; margin-top: 0; margin-bottom: 10px;">ÿßÿ®ÿØÿ£ ÿßŸÑŸÑÿπÿ®ÿ©</button>
                </div>
            </div>
            <div class="game-log">
                <div class="log-content" id="log-content"></div>
            </div>
            <div id="turn-indicator" class="turn-indicator hidden"></div>
        </div>
    </div>
    
    <button id="panel-toggle-btn" style="display:none;">&#9664;</button>

    <div id="game-over-modal" class="modal">
        <div class="modal-content">
            <h2 id="game-over-title">ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÑÿπÿ®ÿ©!</h2>
            <p id="game-over-message"></p>
            <button id="exit-to-menu-btn" class="modal-button">ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÑŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</button>
        </div>
    </div>

    <div id="role-card-modal" class="modal">
        <div class="modal-content">
            <h2 id="role-title"></h2>
            <span id="role-icon" style="font-size: 80px; margin-bottom: 20px; display: block;"></span>
            <p id="role-description"></p>
            <button id="close-role-card-btn" class="modal-button">ŸÅŸáŸÖÿ™</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 1. ELEMENT DECLARATIONS ---
        const socket = io();
        const setupContainer = document.getElementById('setup-container');
        const playerNameInput = document.getElementById('player-name-input');
        const roomIdInput = document.getElementById('room-id-input');
        const createBtn = document.getElementById('create-btn');
        const joinBtn = document.getElementById('join-btn');
        const createOptions = document.getElementById('create-options');
        const joinOptions = document.getElementById('join-options');
        const finalActionBtn = document.getElementById('final-action-btn');
        const playerCountSlider = document.getElementById('player-count-slider');
        const playerCountDisplay = document.getElementById('player-count-display');
        const rolesList = document.getElementById('roles-list');
        const totalRolesSpan = document.getElementById('total-roles');
        const neededRolesSpan = document.getElementById('needed-roles');
        const gameContainer = document.getElementById('game-container');
        const startGameBtnIngame = document.getElementById('start-game-btn-ingame');
        const closeRoleCardBtn = document.getElementById('close-role-card-btn');
        const gameOverModal = document.getElementById('game-over-modal');
        const exitToMenuBtn = document.getElementById('exit-to-menu-btn');
        const roomInfoDisplay = document.getElementById('room-info-display');
        const roomIdText = document.getElementById('room-id-text');
        const copyRoomIdBtn = document.getElementById('copy-room-id-btn');
        const panelToggleBtn = document.getElementById('panel-toggle-btn');
        const logPanel = document.getElementById('log-panel');
        
        const availableRoles = ['ÿßŸÑŸÖÿßŸÅŸäÿß', 'ÿßŸÑŸÖÿ≠ŸÇŸÇ', 'ÿßŸÑÿ∑ÿ®Ÿäÿ®', 'ŸÖŸàÿßÿ∑ŸÜ'];
        let roleCounts = {};
        let localStream;
        let peerConnections = {};
        let currentRoomId = null;

        // --- 2. SETUP SCREEN LOGIC ---
        function initializeSetup() {
            createOptions.style.display = 'block';
            joinOptions.style.display = 'none';
            finalActionBtn.textContent = 'ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÑÿπÿ®ÿ©';
            roleCounts = {};
            availableRoles.forEach(role => {
                roleCounts[role] = (role === 'ÿßŸÑŸÖÿßŸÅŸäÿß' || role === 'ÿßŸÑŸÖÿ≠ŸÇŸÇ' || role === 'ÿßŸÑÿ∑ÿ®Ÿäÿ®') ? 1 : 0;
            });
            roleCounts['ŸÖŸàÿßÿ∑ŸÜ'] = parseInt(playerCountSlider.value) - 3;
            renderRoles();
            updateRoleValidation();
        }
        
        function renderRoles() {
            rolesList.innerHTML = '';
            availableRoles.forEach(role => {
                const item = document.createElement('div');
                item.className = 'role-item';
                item.innerHTML = `<span class="role-name">${role}</span><div class="role-controls"><button class="role-btn" data-role="${role}" data-action="minus">-</button><span class="role-count" id="count-${role}">${roleCounts[role]}</span><button class="role-btn" data-role="${role}" data-action="plus">+</button></div>`;
                rolesList.appendChild(item);
            });
        }

        function updateRoleCount(role, action) {
            if (action === 'plus') { roleCounts[role]++; } 
            else if (action === 'minus' && roleCounts[role] > 0) { roleCounts[role]--; }
            document.getElementById(`count-${role}`).textContent = roleCounts[role];
            updateRoleValidation();
        }

        function updateRoleValidation() {
            const playerCount = parseInt(playerCountSlider.value);
            const totalRoles = Object.values(roleCounts).reduce((a, b) => a + b, 0);
            totalRolesSpan.textContent = totalRoles;
            neededRolesSpan.textContent = playerCount;
            if (totalRoles === playerCount) {
                finalActionBtn.disabled = false;
                totalRolesSpan.style.color = '#00ff00';
            } else {
                finalActionBtn.disabled = true;
                totalRolesSpan.style.color = '#ff0000';
            }
        }
        
        createBtn.addEventListener('click', () => {
            createBtn.classList.add('active'); joinBtn.classList.remove('active');
            createOptions.style.display = 'block'; joinOptions.style.display = 'none';
            finalActionBtn.textContent = 'ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÑÿπÿ®ÿ©';
            updateRoleValidation();
        });

        joinBtn.addEventListener('click', () => {
            joinBtn.classList.add('active'); createBtn.classList.remove('active');
            joinOptions.style.display = 'block'; createOptions.style.display = 'none';
            finalActionBtn.textContent = 'ÿßŸÑÿßŸÜÿ∂ŸÖÿßŸÖ ŸÑŸÑÿπÿ®ÿ©';
            finalActionBtn.disabled = false;
        });

        playerCountSlider.addEventListener('input', (e) => {
            const count = e.target.value;
            playerCountDisplay.textContent = count;
            const specialRoles = Object.keys(roleCounts).filter(r => r !== 'ŸÖŸàÿßÿ∑ŸÜ').reduce((sum, role) => sum + roleCounts[role], 0);
            roleCounts['ŸÖŸàÿßÿ∑ŸÜ'] = count - specialRoles;
            if (roleCounts['ŸÖŸàÿßÿ∑ŸÜ'] < 0) roleCounts['ŸÖŸàÿßÿ∑ŸÜ'] = 0;
            if(document.getElementById('count-ŸÖŸàÿßÿ∑ŸÜ')) document.getElementById('count-ŸÖŸàÿßÿ∑ŸÜ').textContent = roleCounts['ŸÖŸàÿßÿ∑ŸÜ'];
            updateRoleValidation();
        });

        rolesList.addEventListener('click', (e) => {
            if (e.target.classList.contains('role-btn')) {
                updateRoleCount(e.target.dataset.role, e.target.dataset.action);
            }
        });

        finalActionBtn.addEventListener('click', () => {
            const playerName = playerNameInput.value.trim();
            if (!playerName) return alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖŸÉ.');
            
            if (createBtn.classList.contains('active')) {
                const settings = {
                    playerCount: parseInt(playerCountSlider.value),
                    roles: roleCounts,
                    speakingTime: 60,
                    votingTime: 30,
                };
                socket.emit('create-game', playerName, settings);
            } else {
                const roomId = roomIdInput.value.trim().toUpperCase();
                if (!roomId) return alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ©.');
                socket.emit('join-room', roomId, playerName);
            }
        });
        
        copyRoomIdBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(roomIdText.textContent).then(() => {
                alert('ÿ™ŸÖ ŸÜÿ≥ÿÆ ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ©!');
            });
        });

        exitToMenuBtn.addEventListener('click', () => { window.location.reload(); });
        closeRoleCardBtn.addEventListener('click', () => { document.getElementById('role-card-modal').classList.remove('visible'); });

        startGameBtnIngame.addEventListener('click', () => {
            if (currentRoomId) {
                socket.emit('start-game', currentRoomId);
            }
        });
        
        panelToggleBtn.addEventListener('click', () => {
            logPanel.classList.toggle('open');
            panelToggleBtn.classList.toggle('open');
            if (panelToggleBtn.classList.contains('open')) {
                panelToggleBtn.innerHTML = '&#9664;';
            } else {
                panelToggleBtn.innerHTML = '&#9654;';
            }
        });

        // --- 3. SOCKET.IO & GAME HANDLERS ---
        socket.on('game-created', (roomId) => {
            const playerName = playerNameInput.value.trim();
            socket.emit('join-room', roomId, playerName);
        });

       socket.on('joined-successfully', (roomId) => {
            currentRoomId = roomId;
            navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                .then(stream => {
                    localStream = stream;
                    setupContainer.classList.add('hidden');
                    gameContainer.classList.add('visible');
                    roomInfoDisplay.style.display = 'flex';
                    roomIdText.textContent = roomId;
                    
                    // --- ÿßŸÑÿ≥ÿ∑ÿ± ÿßŸÑŸÖÿ∂ÿßŸÅ ŸáŸÜÿß ŸÑÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ≤ÿ± ---
                    document.getElementById('panel-toggle-btn').style.display = 'block';

                }).catch(err => alert("Ÿäÿ¨ÿ® ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÖŸäŸÉÿ±ŸàŸÅŸàŸÜ."));
        });
        
        socket.on('error-message', (message) => { alert(message); });
        
        socket.on('game-over', (message) => {
            deactivatePlayerButtons();
            document.getElementById('game-over-message').textContent = message;
            gameOverModal.classList.add('visible');
        });

        socket.on('update-room-info', (roomInfo) => {
            const { players, hostId, gameState, settings } = roomInfo;
            setupGameBoard(players.map(p => p.name));
            if (socket.id === hostId && players.length >= (settings ? settings.playerCount : 0) && !gameState) {
                startGameBtnIngame.style.display = 'block';
            } else {
                startGameBtnIngame.style.display = 'none';
            }
        });
        
        let soundQueue = [];
        let isSoundPlaying = false;
        
        function processSoundQueue() {
            if (isSoundPlaying || soundQueue.length === 0) return;
            isSoundPlaying = true;
            const soundFile = soundQueue.shift();
            const audio = new Audio(`/sounds/${soundFile}`);
            audio.play().catch(e => console.error("Error playing sound:", e));
            audio.onended = () => { isSoundPlaying = false; processSoundQueue(); };
            audio.onerror = () => { isSoundPlaying = false; processSoundQueue(); };
        }
        
        function addLogMessage(message, type = 'narrative') {
            const logContent = document.getElementById('log-content');
            const messageElement = document.createElement('div');
            messageElement.className = `log-message log-${type}`;
            messageElement.textContent = message;
            logContent.insertBefore(messageElement, logContent.firstChild);
        }

        function setMuteState(isMuted) {
            if (localStream) {
                localStream.getAudioTracks().forEach(track => { track.enabled = !isMuted; });
            }
        }
        
        function setupGameBoard(playerNamesArray) {
            const tableArea = document.getElementById('game-table-area');
            tableArea.innerHTML = '<div id="game-table"></div>'; 
            const table = document.getElementById('game-table');

            playerNamesArray.forEach((playerName, i) => {
                const angle = (i / playerNamesArray.length) * 2 * Math.PI - (Math.PI / 2);
                const radius = table.offsetWidth / 2;
                const x = radius * Math.cos(angle);
                const y = radius * Math.sin(angle);

                const seat = document.createElement('div');
                seat.className = 'player-seat';
                seat.dataset.playerName = playerName;
                seat.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`;
                seat.style.top = '50%';
                seat.style.left = '50%';
                
                seat.innerHTML = `<span class="player-status">üë§</span><span class="player-name">${playerName}</span>`;
                tableArea.appendChild(seat);
            });
        }
        
        function activatePlayerButtons(callback) {
            document.querySelectorAll('.player-seat').forEach(seat => {
                if (!seat.classList.contains('player-seat--eliminated')) {
                    seat.classList.add('clickable');
                    seat.onclick = () => callback(seat.dataset.playerName);
                }
            });
        }

        function deactivatePlayerButtons() {
            document.querySelectorAll('.player-seat').forEach(seat => {
                seat.classList.remove('clickable');
                seat.onclick = null;
            });
        }

        socket.on('receive-role', (roleInfo) => {
            const roleCardModal = document.getElementById('role-card-modal');
            document.getElementById('role-title').textContent = roleInfo.title;
            document.getElementById('role-icon').textContent = roleInfo.icon;
            document.getElementById('role-description').textContent = roleInfo.description;
            roleCardModal.classList.add('visible');
        });
        
        socket.on('game-update', (data) => {
            switch(data.event) {
                case 'log': addLogMessage(data.message, data.type); break;
                case 'set-theme': document.body.classList.toggle('theme-day', data.theme === 'day'); break;
                case 'play-sound': soundQueue.push(data.file); processSoundQueue(); break;
            }
        });

        let speakerTimerInterval;
        socket.on('start-speaker-turn', ({ speakerName, time }) => {
            document.querySelectorAll('.player-seat--speaking').forEach(el => el.classList.remove('player-seat--speaking'));
            const speakerSeat = document.querySelector(`[data-player-name="${speakerName}"]`);
            if (speakerSeat) speakerSeat.classList.add('player-seat--speaking');
            const turnIndicator = document.getElementById('turn-indicator');
            turnIndicator.classList.remove('hidden');
            let timeLeft = parseInt(time);
            turnIndicator.innerHTML = `
                <div class="turn-player">ÿØŸàÿ± ${speakerName} ŸÑŸÑŸÉŸÑÿßŸÖ...</div>
                <div class="turn-timer">${timeLeft}</div>
                <button id="skip-turn-btn" class="modal-button" style="margin-top:10px;">ÿ™ÿÆÿ∑Ÿä ÿßŸÑÿØŸàÿ±</button>
            `;
            document.getElementById('skip-turn-btn').onclick = () => {
                socket.emit('skip-speaker-turn', currentRoomId);
            };
            clearInterval(speakerTimerInterval);
            speakerTimerInterval = setInterval(() => {
                timeLeft--;
                const timerEl = turnIndicator.querySelector('.turn-timer');
                if (timerEl) timerEl.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(speakerTimerInterval);
                }
            }, 1000);
        });

        socket.on('perform-night-action', ({ prompt, canChooseSelf }) => {
            addLogMessage(prompt, 'alert');
            activatePlayerButtons((chosenPlayer) => {
                if (!canChooseSelf && chosenPlayer === playerNameInput.value.trim()) {
                    addLogMessage('ŸÑÿß ŸäŸÖŸÉŸÜŸÉ ÿßÿÆÿ™Ÿäÿßÿ± ŸÜŸÅÿ≥ŸÉ.', 'system'); return;
                }
                deactivatePlayerButtons();
                socket.emit('submit-night-action', currentRoomId, chosenPlayer);
            });
        });

        socket.on('perform-vote', () => {
            document.getElementById('turn-indicator').classList.add('hidden');
            activatePlayerButtons((chosenPlayer) => {
                deactivatePlayerButtons();
                socket.emit('submit-vote', currentRoomId, chosenPlayer);
            });
        });
        
        socket.on('player-eliminated', (playerName) => {
            const seat = document.querySelector(`[data-player-name="${playerName}"]`);
            if (seat) {
                seat.classList.add('player-seat--eliminated');
                seat.querySelector('.player-status').textContent = 'üíÄ';
            }
        });

        socket.on('mute-all', () => setMuteState(true));
        socket.on('unmute-all', () => setMuteState(false));
        socket.on('enter-mafia-channel', (mafiaSocketIds) => {
            if (mafiaSocketIds.includes(socket.id)) setMuteState(false); else setMuteState(true);
        });
        socket.on('exit-mafia-channel', () => setMuteState(true));

        socket.on('user-joined', (newSocketId) => createPeerConnection(newSocketId, true));
        socket.on('user-left', (socketId) => {
            if (peerConnections[socketId]) { peerConnections[socketId].close(); delete peerConnections[socketId]; }
            const audioEl = document.getElementById(`audio-${socketId}`);
            if (audioEl) audioEl.remove();
        });
        socket.on('offer', (senderSocketId, offer) => {
            createPeerConnection(senderSocketId, false);
            peerConnections[senderSocketId].setRemoteDescription(new RTCSessionDescription(offer))
                .then(() => peerConnections[senderSocketId].createAnswer())
                .then(answer => {
                    peerConnections[senderSocketId].setLocalDescription(answer);
                    socket.emit('answer', senderSocketId, answer);
                });
        });
        socket.on('answer', (senderSocketId, answer) => peerConnections[senderSocketId].setRemoteDescription(new RTCSessionDescription(answer)));
        socket.on('ice-candidate', (senderSocketId, candidate) => {
            if (peerConnections[senderSocketId]) peerConnections[senderSocketId].addIceCandidate(new RTCIceCandidate(candidate));
        });

        function createPeerConnection(targetSocketId, isInitiator) {
            if (peerConnections[targetSocketId]) return;
            peerConnections[targetSocketId] = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            if(localStream) {
                localStream.getTracks().forEach(track => peerConnections[targetSocketId].addTrack(track, localStream));
            }
            peerConnections[targetSocketId].ontrack = (event) => {
                let audio = document.getElementById(`audio-${targetSocketId}`);
                if (!audio) {
                    audio = document.createElement('audio');
                    audio.id = `audio-${targetSocketId}`;
                    audio.autoplay = true;
                    document.body.appendChild(audio);
                }
                audio.srcObject = event.streams[0];
            };
            peerConnections[targetSocketId].onicecandidate = (event) => {
                if (event.candidate) socket.emit('ice-candidate', targetSocketId, event.candidate);
            };
            if (isInitiator) {
                peerConnections[targetSocketId].createOffer()
                    .then(offer => peerConnections[targetSocketId].setLocalDescription(offer))
                    .then(() => socket.emit('offer', targetSocketId, peerConnections[targetSocketId].localDescription));
            }
        }
        
        initializeSetup();
    });
    </script>
</body>
</html>